from __future__ import absolute_import, division, unicode_literals
from six import text_type
from six.moves import http_client

import codecs
import re

from .constants import EOF, spaceCharacters, asciiLetters, asciiUppercase
from .constants import encodings, ReparseException
from . import utils

from io import StringIO

try:
    from io import BytesIO
except ImportError:
    BytesIO = StringIO

try:
    from io import BufferedIOBase
except ImportError:
    class BufferedIOBase(object):
        pass

# Non-unicode versions of constants for use in the pre-parser
spaceCharactersBytes = frozenset([item.encode("ascii") for item in spaceCharacters])
asciiLettersBytes = frozenset([item.encode("ascii") for item in asciiLetters])
asciiUppercaseBytes = frozenset([item.encode("ascii") for item in asciiUppercase])
spacesAngleBrackets = spaceCharactersBytes | frozenset([b">", b"<"])


invalid_unicode_no_surrogate = "[\u0001-\u0008\u000B\u000E-\u001F\u007F-\u009F\uFDD0-\uFDEF\uFFFE\uFFFF\U0001FFFE\U0001FFFF\U0002FFFE\U0002FFFF\U0003FFFE\U0003FFFF\U0004FFFE\U0004FFFF\U0005FFFE\U0005FFFF\U0006FFFE\U0006FFFF\U0007FFFE\U0007FFFF\U0008FFFE\U0008FFFF\U0009FFFE\U0009FFFF\U000AFFFE\U000AFFFF\U000BFFFE\U000BFFFF\U000CFFFE\U000CFFFF\U000DFFFE\U000DFFFF\U000EFFFE\U000EFFFF\U000FFFFE\U000FFFFF\U0010FFFE\U0010FFFF]"

if utils.supports_lone_surrogates:
    # Use one extra step of indirection and create surrogates with
    # unichr. Not using this indirection would introduce an illegal
    # unicode literal on platforms not supporting such lone
    # surrogates.
    invalid_unicode_re = re.compile(invalid_unicode_no_surrogate +
                                    eval('"\\uD800-\\uDFFF"'))
else:
    invalid_unicode_re = re.compile(invalid_unicode_no_surrogate)

non_bmp_invalid_codepoints = set([0x1FFFE, 0x1FFFF, 0x2FFFE, 0x2FFFF, 0x3FFFE,
                                  0x3FFFF, 0x4FFFE, 0x4FFFF, 0x5FFFE, 0x5FFFF,
                                  0x6FFFE, 0x6FFFF, 0x7FFFE, 0x7FFFF, 0x8FFFE,
                                  0x8FFFF, 0x9FFFE, 0x9FFFF, 0xAFFFE, 0xAFFFF,
                                  0xBFFFE, 0xBFFFF, 0xCFFFE, 0xCFFFF, 0xDFFFE,
                                  0xDFFFF, 0xEFFFE, 0xEFFFF, 0xFFFFE, 0xFFFFF,
                                  0x10FFFE, 0x10FFFF])

ascii_punctuation_re = re.compile("[\u0009-\u000D\u0020-\u002F\u003A-\u0040\u005B-\u0060\u007B-\u007E]")

# Cache for charsUntil()
charsUntilRegEx = {}


class BufferedStream(object):
    """Buffering for streams that do not have buffering of their own

    The buffer is implemented as a list of chunks on the assumption that
    joining many strings will be slow since it is O(n**2)
    """

    def __init__(self, stream):
        self.stream = stream
        self.buffer = []
        self.position = [-1, 0]  # chunk number, offset

    def tell(self):
        pos = 0
        for chunk in self.buffer[:self.position[0]]:
            pos += len(chunk)
        pos += self.position[1]
        return pos

    def seek(self, pos):
        assert pos <= self._bufferedBytes()
        offset = pos
        i = 0
        while len(self.buffer[i]) < offset:
            offset -= len(self.buffer[i])
            i += 1
        self.position = [i, offset]

    def read(self, bytes):
        if not self.buffer:
            return self._readStream(bytes)
        elif (self.position[0] == len(self.buffer) and
              self.position[1] == len(self.buffer[-1])):
            return self._readStream(bytes)
        else:
            return self._readFromBuffer(bytes)

    def _bufferedBytes(self):
        return sum([len(item) for item in self.buffer])

    def _readStream(self, bytes):
        data = self.stream.read(bytes)
        self.buffer.append(data)
        self.position[0] += 1
        self.position[1] = len(data)
        return data

    def _readFromBuffer(self, bytes):
        remainingBytes = bytes
        rv = []
        bufferIndex = self.position[0]
        bufferOffset = self.position[1]
        while bufferIndex < len(self.buffer) and remainingBytes != 0:
            assert remainingBytes > 0
            bufferedData = self.buffer[bufferIndex]

            if remainingBytes <= len(bufferedData) - bufferOffset:
                bytesToRead = remainingBytes
                self.position = [bufferIndex, bufferOffset + bytesToRead]
            else:
                bytesToRead = len(bufferedData) - bufferOffset
                self.position = [bufferIndex, len(bufferedData)]
                bufferIndex += 1
            rv.append(bufferedData[bufferOffset:bufferOffset + bytesToRead])
            remainingBytes -= bytesToRead

            bufferOffset = 0

        if remainingBytes:
            rv.append(self._readStream(remainingBytes))

        return b"".join(rv)


def HTMLInputStream(source, encoding=None, parseMeta=True, chardet=True):
    if isinstance(source, http_client.HTTPResponse):
        # Work around Python bug #20007: read(0) closes the connection.
        # http://bugs.python.org/issue20007
        isUnicode = False
    elif hasattr(source, "read"):
        isUnicode = isinstance(source.read(0), text_type)
    else:
        isUnicode = isinstance(source, text_type)

    if isUnicode:
        if encoding is not None:
            raise TypeError("Cannot explicitly set an encoding with a unicode string")

        return HTMLUnicodeInputStream(source)
    else:
        return HTMLBinaryInputStream(source, encoding, parseMeta, chardet)


class HTMLUnicodeInputStream(object):
    """Provides a unicode stream of characters to the HTMLTokenizer.

    This class takes care of character encoding and removing or replacing
    incorrect byte-sequences and also provides column and line tracking.

    """

    _defaultChunkSize = 10240

    def __init__(self, source):
        """Initialises the HTMLInputStream.

        HTMLInputStream(source, [encoding]) -> Normalized stream from source
        for use by html5lib.

        source can be either a file-object, local filename or a string.

        The optional encoding parameter must be a string that indicates
        the encoding.  If specified, that encoding will be used,
        regardless of any BOM or later declaration (such as in a meta
        element)

        parseMeta - Look for a <meta> element containing encoding information

        """

        if not utils.supports_lone_surrogates:
            # Such platforms will have already checked for such
            # surrogate errors, so no need to do this checking.
            self.reportCharacterErrors = None
            self.replaceCharactersRegexp = None
        elif len("\U0010FFFF") == 1:
            self.reportCharacterErrors = self.characterErrorsUCS4
            self.replaceCharactersRegexp = re.compile(eval('"[\\uD800-\\uDFFF]"'))
        else:
            self.reportCharacterErrors = self.characterErrorsUCS2
            self.replaceCharactersRegexp = re.compile(
                eval('"([\\uD800-\\uDBFF](?![\\uDC00-\\uDFFF])|(?<![\\uD800-\\uDBFF])[\\uDC00-\\uDFFF])"'))

        # List of where new lines occur
        self.newLines = [0]

        self.charEncoding = ("utf-8", "certain")
        self.dataStream = self.openStream(source)

        self.reset()

    def reset(self):
        self.chunk = ""
        self.chunkSize = 0
        self.chunkOffset = 0
        self.errors = []

        # number of (complete) lines in previous chunks
        self.prevNumLines = 0
        # number of columns in the last line of the previous chunk
        self.prevNumCols = 0

        # Deal with CR LF and surrogates split over chunk boundaries
        self._bufferedCharacter = None

    def openStream(self, source):
        """Produces a file object from source.

        source can be either a file object, local filename or a string.

        """
        # Already a file object
        if hasattr(source, 'read'):
            stream = source
        else:
            stream = StringIO(source)

        return stream

    def _position(self, offset):
        chunk = self.chunk
        nLines = chunk.count('\n', 0, offset)
        positionLine = self.prevNumLines + nLines
        lastLinePos = chunk.rfind('\n', 0, offset)
        if lastLinePos == -1:
            positionColumn = self.prevNumCols + offset
        else:
            positionColumn = offset - (lastLinePos + 1)
        return (positionLine, positionColumn)

    def position(self):
        """Returns (line, col) of the current position in the stream."""
        line, col = self._position(self.chunkOffset)
        return (line + 1, col)

    def char(self):
        """ Read one character from the stream or queue if available. Return
            EOF when EOF is reached.
        """
        # Read a new chunk from the input stream if necessary
        if self.chunkOffset >= self.chunkSize:
            if not self.readChunk():
                return EOF

        chunkOffset = self.chunkOffset
        char = self.chunk[chunkOffset]
        self.chunkOffset = chunkOffset + 1

        return char

    def readChunk(self, chunkSize=None):
        if chunkSize is None:
            chunkSize = self._defaultChunkSize

        self.prevNumLines, self.prevNumCols = self._position(self.chunkSize)

        self.chunk = ""
        self.chunkSize = 0
        self.chunkOffset = 0

        data = self.dataStream.read(chunkSize)

        # Deal with CR LF and surrogates broken across chunks
        if self._bufferedCharacter:
            data = self._bufferedCharacter + data
            self._bufferedCharacter = None
        elif not data:
            # We have no more data, bye-bye stream
            return False

        if len(data) > 1:
            lastv = ord(data[-1])
            if lastv == 0x0D or 0xD800 <= lastv <= 0xDBFF:
                self._bufferedCharacter = data[-1]
                data = data[:-1]

        if self.reportCharacterErrors:
            self.reportCharacterErrors(data)

            # Replace invalid characters
            # Note U+0000 is dealt with in the tokenizer
            data = self.replaceCharactersRegexp.sub("\ufffd", data)

        data = data.replace("\r\n", "\n")
        data = data.replace("\r", "\n")

        self.chunk = data
        self.chunkSize = len(data)

        return True

    def characterErrorsUCS4(self, data):
        for i in range(len(invalid_unicode_re.findall(data))):
            self.errors.append("invalid-codepoint")

    def characterErrorsUCS2(self, data):
        # Someone picked the wrong compile option
        # You lose
        skip = False
        for match in invalid_unicode_re.finditer(data):
            if skip:
                continue
            codepoint = ord(match.group())
            pos = match.start()
            # Pretty sure there should be endianness issues here
            if utils.isSurrogatePair(data[pos:pos + 2]):
                # We have a surrogate pair!
                char_val = utils.surrogatePairToCodepoint(data[pos:pos + 2])
                if char_val in non_bmp_invalid_codepoints:
                    self.errors.append("invalid-codepoint")
                skip = True
            elif (codepoint >= 0xD800 and codepoint <= 0xDFFF and
                  pos == len(data) - 1):
                self.errors.append("invalid-codepoint")
            else:
                skip = False
                self.errors.append("invalid-codepoint")

    def charsUntil(self, characters, opposite=False):
        """ Returns a string of characters from the stream up to but not
        including any character in 'characters' or EOF. 'characters' must be
        a container that supports the 'in' method and iteration over its
        characters.
        """

        # Use a cache of regexps to find the required characters
        try:
            chars = charsUntilRegEx[(characters, opposite)]
        except KeyError:
            if __debug__:
                for c in characters:
                    assert(ord(c) < 128)
            regex = "".join(["\\x%02x" % ord(c) for c in characters])
            if not opposite:
                regex = "^%s" % regex
            chars = charsUntilRegEx[(characters, opposite)] = re.compile("[%s]+" % regex)

        rv = []

        while True:
            # Find the longest matching prefix
            m = chars.match(self.chunk, self.chunkOffset)
            if m is None:
                # If nothing matched, and it wasn't because we ran out of chunk,
                # then stop
                if self.chunkOffset != self.chunkSize:
                    break
            else:
                end = m.end()
                # If not the whole chunk matched, return everything
                # up to the part that didn't match
                if end != self.chunkSize:
                    rv.append(self.chunk[self.chunkOffset:end])
                    self.chunkOffset = end
                    break
            # If the whole remainder of the chunk matched,
            # use it all and read the next chunk
            rv.append(self.chunk[self.chunkOffset:])
            if not self.readChunk():
                # Reached EOF
                break

        r = "".join(rv)
        return r

    def unget(self, char):
        # Only one character is allowed to be ungotten at once - it must
        # be consumed again before any further call to unget
        if char is not None:
            if self.chunkOffset == 0:
                # unget is called quite rarely, so it's a good idea to do
                # more work here if it saves a bit of work in the frequently
                # called char and charsUntil.
                # So, just prepend the ungotten character onto the current
                # chunk:
                self.chunk = char + self.chunk
                self.chunkSize += 1
            else:
                self.chunkOffset -= 1
                assert self.chunk[self.chunkOffset] == char


class HTMLBinaryInputStream(HTMLUnicodeInputStream):
    """Provides a unicode stream of characters to the HTMLTokenizer.

    This class takes care of character encoding and removing or replacing
    incorrect byte-sequences and also provides column and line tracking.

    """

    def __init__(self, source, encoding=None, parseMeta=True, chardet=True):
        """Initialises the HTMLInputStream.

        HTMLInputStream(source, [encoding]) -> Normalized stream from source
        for use by html5lib.

        source can be either a file-object, local filename or a string.

        The optional encoding parameter must be a string that indicates
        the encoding.  If specified, that encoding will be used,
        regardless of any BOM or later declaration (such as in a meta
        element)

        parseMeta - Look for a <meta> element containing encoding information

        """
        # Raw Stream - for unicode objects this will encode to utf-8 and set
        #              self.charEncoding as appropriate
        self.rawStream = self.openStream(source)

        HTMLUnicodeInputStream.__init__(self, self.rawStream)

        self.charEncoding = (codecName(encoding), "certain")

        # Encoding Information
        # Number of bytes to use when looking for a meta element with
        # encoding information
        self.numBytesMeta = 512
        # Number of bytes to use when using detecting encoding using chardet
        self.numBytesChardet = 100
        # Encoding to use if no other information can be found
        self.defaultEncoding = "windows-1252"

        # Detect encoding iff no explicit "transport level" encoding is supplied
        if (self.charEncoding[0] is None):
            self.charEncoding = self.detectEncoding(parseMeta, chardet)

        # Call superclass
        self.reset()

    def reset(self):
        self.dataStream = codecs.getreader(self.charEncoding[0])(self.rawStream,
                                                                 'replace')
        HTMLUnicodeInputStream.reset(self)

    def openStream(self, source):
        """Produces a file object from source.

        source can be either a file object, local filename or a string.

        """
        # Already a file object
        if hasattr(source, 'read'):
            stream = source
        else:
            stream = BytesIO(source)

        try:
            stream.seek(stream.tell())
        except:
            stream = BufferedStream(stream)

        return stream

    def detectEncoding(self, parseMeta=True, chardet=True):
        # First look for a BOM
        # This will also read past the BOM if present
        encoding = self.detectBOM()
        confidence = "certain"
        # If there is no BOM need to look for meta elements with encoding
        # information
        if encoding is None and parseMeta:
            encoding = self.detectEncodingMeta()
            confidence = "tentative"
        # Guess with chardet, if avaliable
        if encoding is None and chardet:
            confidence = "tentative"
            try:
                try:
                    from charade.universaldetector import UniversalDetector
                except ImportError:
                    from chardet.universaldetector import UniversalDetector
                buffers = []
                detector = UniversalDetector()
                while not detector.done:
                    buffer = self.rawStream.read(self.numBytesChardet)
                    assert isinstance(buffer, bytes)
                    if not buffer:
                        break
                    buffers.append(buffer)
                    detector.feed(buffer)
                detector.close()
                encoding = detector.result['encoding']
                self.rawStream.seek(0)
            except ImportError:
                pass
        # If all else fails use the default encoding
        if encoding is None:
            confidence = "tentative"
            encoding = self.defaultEncoding

        # Substitute for equivalent encodings:
        encodingSub = {"iso-8859-1": "windows-1252"}

        if encoding.lower() in encodingSub:
            encoding = encodingSub[encoding.lower()]

        return encoding, confidence

    def changeEncoding(self, newEncoding):
        assert self.charEncoding[1] != "certain"
        newEncoding = codecName(newEncoding)
        if newEncoding in ("utf-16", "utf-16-be", "utf-16-le"):
            newEncoding = "utf-8"
        if newEncoding is None:
            return
        elif newEncoding == self.charEncoding[0]:
            self.charEncoding = (self.charEncoding[0], "certain")
        else:
            self.rawStream.seek(0)
            self.reset()
            self.charEncoding = (newEncoding, "certain")
            raise ReparseException("Encoding changed from %s to %s" % (self.charEncoding[0], newEncoding))

    def detectBOM(self):
        """Attempts to detect at BOM at the start of the stream. If
        an encoding can be determined from the BOM return the name of the
        encoding otherwise return None"""
        bomDict = {
            codecs.BOM_UTF8: 'utf-8',
            codecs.BOM_UTF16_LE: 'utf-16-le', codecs.BOM_UTF16_BE: 'utf-16-be',
            codecs.BOM_UTF32_LE: 'utf-32-le', codecs.BOM_UTF32_BE: 'utf-32-be'
        }

        # Go to beginning of file and read in 4 bytes
        string = self.rawStream.read(4)
        assert isinstance(string, bytes)

        # Try detecting the BOM using bytes from the string
        encoding = bomDict.get(string[:3])         # UTF-8
        seek = 3
        if not encoding:
            # Need to detect UTF-32 before UTF-16
            encoding = bomDict.get(string)         # UTF-32
            seek = 4
            if not encoding:
                encoding = bomDict.get(string[:2])  # UTF-16
                seek = 2

        # Set the read position past the BOM if one was found, otherwise
        # set it to the start of the stream
        self.rawStream.seek(encoding and seek or 0)

        return encoding

    def detectEncodingMeta(self):
        """Report the encoding declared by the meta element
        """
        buffer = self.rawStream.read(self.numBytesMeta)
        assert isinstance(buffer, bytes)
        parser = EncodingParser(buffer)
        self.rawStream.seek(0)
        encoding = parser.getEncoding()

        if encoding in ("utf-16", "utf-16-be", "utf-16-le"):
            encoding = "utf-8"

        return encoding


class EncodingBytes(bytes):
    """String-like object with an associated position and various extra methods
    If the position is ever greater than the string length then an exception is
    raised"""
    def __new__(self, value):
        assert isinstance(value, bytes)
        return bytes.__new__(self, value.lower())

    def __init__(self, value):
        self._position = -1

    def __iter__(self):
        return self

    def __next__(self):
        p = self._position = self._position + 1
        if p >= len(self):
            raise StopIteration
        elif p < 0:
            raise TypeError
        return self[p:p + 1]

    def next(self):
        # Py2 compat
        return self.__next__()

    def previous(self):
        p = self._position
        if p >= len(self):
            raise StopIteration
        elif p < 0:
            raise TypeError
        self._position = p = p - 1
        return self[p:p + 1]

    def setPosition(self, position):
        if self._position >= len(self):
            raise StopIteration
        self._position = position

    def getPosition(self):
        if self._position >= len(self):
            raise StopIteration
        if self._position >= 0:
            return self._position
        else:
            return None

    position = property(getPosition, setPosition)

    def getCurrentByte(self):
        return self[self.position:self.position + 1]

    currentByte = property(getCurrentByte)

    def skip(self, chars=spaceCharactersBytes):
        """Skip past a list of characters"""
        p = self.position               # use property for the error-checking
        while p < len(self):
            c = self[p:p + 1]
            if c not in chars:
                self._position = p
                return c
            p += 1
        self._position = p
        return None

    def skipUntil(self, chars):
        p = self.position
        while p < len(self):
            c = self[p:p + 1]
            if c in chars:
                self._position = p
                return c
            p += 1
        self._position = p
        return None

    def matchBytes(self, bytes):
        """Look for a sequence of bytes at the start of a string. If the bytes
        are found return True and advance the position to the byte after the
        match. Otherwise return False and leave the position alone"""
        p = self.position
        data = self[p:p + len(bytes)]
        rv = data.startswith(bytes)
        if rv:
            self.position += len(bytes)
        return rv

    def jumpTo(self, bytes):
        """Look for the next sequence of bytes matching a given sequence. If
        a match is found advance the position to the last byte of the match"""
        newPosition = self[self.position:].find(bytes)
        if newPosition > -1:
            # XXX: This is ugly, but I can't see a nicer way to fix this.
            if self._position == -1:
                self._position = 0
            self._position += (newPosition + len(bytes) - 1)
            return True
        else:
            raise StopIteration


class EncodingParser(object):
    """Mini parser for detecting character encoding from meta elements"""

    def __init__(self, data):
        """string - the data to work on for encoding detection"""
        self.data = EncodingBytes(data)
        self.encoding = None

    def getEncoding(self):
        methodDispatch = (
            (b"<!--", self.handleComment),
            (b"<meta", self.handleMeta),
            (b"</", self.handlePossibleEndTag),
            (b"<!", self.handleOther),
            (b"<?", self.handleOther),
            (b"<", self.handlePossibleStartTag))
        for byte in self.data:
            keepParsing = True
            for key, method in methodDispatch:
                if self.data.matchBytes(key):
                    try:
                        keepParsing = method()
                        break
                    except StopIteration:
                        keepParsing = False
                        break
            if not keepParsing:
                break

        return self.encoding

    def handleComment(self):
        """Skip over comments"""
        return self.data.jumpTo(b"-->")

    def handleMeta(self):
        if self.data.currentByte not in spaceCharactersBytes:
            # if we have <meta not followed by a space so just keep going
            return True
        # We have a valid meta element we want to search for attributes
        hasPragma = False
        pendingEncoding = None
        while True:
            # Try to find the next attribute after the current position
            attr = self.getAttribute()
            if attr is None:
                return True
            else:
                if attr[0] == b"http-equiv":
                    hasPragma = attr[1] == b"content-type"
                    if hasPragma and pendingEncoding is not None:
                        self.encoding = pendingEncoding
                        return False
                elif attr[0] == b"charset":
                    tentativeEncoding = attr[1]
                    codec = codecName(tentativeEncoding)
                    if codec is not None:
                        self.encoding = codec
                        return False
                elif attr[0] == b"content":
                    contentParser = ContentAttrParser(EncodingBytes(attr[1]))
                    tentativeEncoding = contentParser.parse()
                    if tentativeEncoding is not None:
                        codec = codecName(tentativeEncoding)
                        if codec is not None:
                            if hasPragma:
                                self.encoding = codec
                                return False
                            else:
                                pendingEncoding = codec

    def handlePossibleStartTag(self):
        return self.handlePossibleTag(False)

    def handlePossibleEndTag(self):
        next(self.data)
        return self.handlePossibleTag(True)

    def handlePossibleTag(self, endTag):
        data = self.data
        if data.currentByte not in asciiLettersBytes:
            # If the next byte is not an ascii letter either ignore this
            # fragment (possible start tag case) or treat it according to
            # handleOther
            if endTag:
                data.previous()
                self.handleOther()
            return True

        c = data.skipUntil(spacesAngleBrackets)
        if c == b"<":
            # return to the first step in the overall "two step" algorithm
            # reprocessing the < byte
            data.previous()
        else:
            # Read all attributes
            attr = self.getAttribute()
            while attr is not None:
                attr = self.getAttribute()
        return True

    def handleOther(self):
        return self.data.jumpTo(b">")

    def getAttribute(self):
        """Return a name,value pair for the next attribute in the stream,
        if one is found, or None"""
        data = self.data
        # Step 1 (skip chars)
        c = data.skip(spaceCharactersBytes | frozenset([b"/"]))
        assert c is None or len(c) == 1
        # Step 2
        if c in (b">", None):
            return None
        # Step 3
        attrName = []
        attrValue = []
        # Step 4 attribute name
        while True:
            if c == b"=" and attrName:
                break
            elif c in spaceCharactersBytes:
                # Step 6!
                c = data.skip()
                break
            elif c in (b"/", b">"):
                return b"".join(attrName), b""
            elif c in asciiUppercaseBytes:
                attrName.append(c.lower())
            elif c is None:
                return None
            else:
                attrName.append(c)
            # Step 5
            c = next(data)
        # Step 7
        if c != b"=":
            data.previous()
            return b"".join(attrName), b""
        # Step 8
        next(data)
        # Step 9
        c = data.skip()
        # Step 10
        if c in (b"'", b'"'):
            # 10.1
            quoteChar = c
            while True:
                # 10.2
                c = next(data)
                # 10.3
                if c == quoteChar:
                    next(data)
                    return b"".join(attrName), b"".join(attrValue)
                # 10.4
                elif c in asciiUppercaseBytes:
                    attrValue.append(c.lower())
                # 10.5
                else:
                    attrValue.append(c)
        elif c == b">":
            return b"".join(attrName), b""
        elif c in asciiUppercaseBytes:
            attrValue.append(c.lower())
        elif c is None:
            return None
        else:
            attrValue.append(c)
        # Step 11
        while True:
            c = next(data)
            if c in spacesAngleBrackets:
                return b"".join(attrName), b"".join(attrValue)
            elif c in asciiUppercaseBytes:
                attrValue.append(c.lower())
            elif c is None:
                return None
            else:
                attrValue.append(c)


class ContentAttrParser(object):
    def __init__(self, data):
        assert isinstance(data, bytes)
        self.data = data

    def parse(self):
        try:
            # Check if the attr name is charset
            # otherwise return
            self.data.jumpTo(b"charset")
            self.data.position += 1
            self.data.skip()
            if not self.data.currentByte == b"=":
                # If there is no = sign keep looking for attrs
                return None
            self.data.position += 1
            self.data.skip()
            # Look for an encoding between matching quote marks
            if self.data.currentByte in (b'"', b"'"):
                quoteMark = self.data.currentByte
                self.data.position += 1
                oldPosition = self.data.position
                if self.data.jumpTo(quoteMark):
                    return self.data[oldPosition:self.data.position]
                else:
                    return None
            else:
                # Unquoted value
                oldPosition = self.data.position
                try:
                    self.data.skipUntil(spaceCharactersBytes)
                    return self.data[oldPosition:self.data.position]
                except StopIteration:
                    # Return the whole remaining value
                    return self.data[oldPosition:]
        except StopIteration:
            return None


def codecName(encoding):
    """Return the python codec name corresponding to an encoding or None if the
    string doesn't correspond to a valid encoding."""
    if isinstance(encoding, bytes):
        try:
            encoding = encoding.decode("ascii")
        except UnicodeDecodeError:
            return None
    if encoding:
        canonicalName = ascii_punctuation_re.sub("", encoding).lower()
        return encodings.get(canonicalName, None)
    else:
        return None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="lexUnit.xsl"?>
<lexUnit status="Finished_Initial" POS="V" name="reassure.v" ID="11810" frame="Reassuring" frameID="1378" totalAnnotated="20" xsi:schemaLocation="../schema/lexUnit.xsd" xmlns="http://framenet.icsi.berkeley.edu" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <header>
        <corpus description="BNC2" name="BNC2" ID="111">
            <document description="bncp" name="bncp" ID="421"/>
        </corpus>
        <frame>
            <FE fgColor="FFFFFF" bgColor="FF69B4" type="Peripheral" abbrev="Amo" name="Amount_of_reassurance"/>
            <FE fgColor="FFFFFF" bgColor="9400D3" type="Extra-Thematic" abbrev="Dep-Act" name="Depictive"/>
            <FE fgColor="FFFFFF" bgColor="008000" type="Core" abbrev="Exp" name="Experiencer"/>
            <FE fgColor="FFFFFF" bgColor="FF00FF" type="Peripheral" abbrev="Manr" name="Manner"/>
            <FE fgColor="FFFFFF" bgColor="A52A2A" type="Peripheral" abbrev="Mns" name="Means"/>
            <FE fgColor="FFFFFF" bgColor="9F79EE" type="Peripheral" abbrev="Medium" name="Medium"/>
            <FE fgColor="FFFFFF" bgColor="0000FF" type="Core" abbrev="Msg" name="Message"/>
            <FE fgColor="FFFFFF" bgColor="1E90FF" type="Core" abbrev="Sit" name="Situation"/>
            <FE fgColor="FFFFFF" bgColor="FF0000" type="Core" abbrev="Spkr" name="Speaker"/>
            <FE fgColor="FFFFFF" bgColor="FFA500" type="Peripheral" abbrev="" name="Time"/>
        </frame>
    </header>
    <definition>COD: allay the doubts and fears of</definition>
    <lexeme POS="V" name="reassure"/>
    <valences>
        <FERealization total="20">
            <FE name="Experiencer"/>
            <pattern total="20">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <annoSet ID="2086375"/>
                <annoSet ID="2086377"/>
                <annoSet ID="2086379"/>
                <annoSet ID="2086381"/>
                <annoSet ID="2086393"/>
                <annoSet ID="2086399"/>
                <annoSet ID="2086403"/>
                <annoSet ID="2086407"/>
                <annoSet ID="2086413"/>
                <annoSet ID="2086675"/>
                <annoSet ID="2086677"/>
                <annoSet ID="2086681"/>
                <annoSet ID="2086685"/>
                <annoSet ID="2086691"/>
                <annoSet ID="2086695"/>
                <annoSet ID="2086705"/>
                <annoSet ID="2086713"/>
                <annoSet ID="2086743"/>
                <annoSet ID="2086787"/>
                <annoSet ID="2086801"/>
            </pattern>
        </FERealization>
        <FERealization total="3">
            <FE name="Manner"/>
            <pattern total="3">
                <valenceUnit GF="Dep" PT="AVP" FE="Manner"/>
                <annoSet ID="2086381"/>
                <annoSet ID="2086407"/>
                <annoSet ID="2086801"/>
            </pattern>
        </FERealization>
        <FERealization total="3">
            <FE name="Means"/>
            <pattern total="1">
                <valenceUnit GF="Dep" PT="PP[by]" FE="Means"/>
                <annoSet ID="2086681"/>
            </pattern>
            <pattern total="2">
                <valenceUnit GF="Dep" PT="PP[with]" FE="Means"/>
                <annoSet ID="2086695"/>
                <annoSet ID="2086705"/>
            </pattern>
        </FERealization>
        <FERealization total="13">
            <FE name="Message"/>
            <pattern total="3">
                <valenceUnit GF="Dep" PT="QUO" FE="Message"/>
                <annoSet ID="2086743"/>
                <annoSet ID="2086787"/>
                <annoSet ID="2086801"/>
            </pattern>
            <pattern total="10">
                <valenceUnit GF="Dep" PT="Sfin" FE="Message"/>
                <annoSet ID="2086375"/>
                <annoSet ID="2086377"/>
                <annoSet ID="2086379"/>
                <annoSet ID="2086381"/>
                <annoSet ID="2086393"/>
                <annoSet ID="2086399"/>
                <annoSet ID="2086403"/>
                <annoSet ID="2086407"/>
                <annoSet ID="2086413"/>
                <annoSet ID="2086713"/>
            </pattern>
        </FERealization>
        <FERealization total="7">
            <FE name="Situation"/>
            <pattern total="5">
                <valenceUnit GF="Dep" PT="PP[about]" FE="Situation"/>
                <annoSet ID="2086675"/>
                <annoSet ID="2086677"/>
                <annoSet ID="2086681"/>
                <annoSet ID="2086685"/>
                <annoSet ID="2086691"/>
            </pattern>
            <pattern total="2">
                <valenceUnit GF="" PT="DNI" FE="Situation"/>
                <annoSet ID="2086695"/>
                <annoSet ID="2086705"/>
            </pattern>
        </FERealization>
        <FERealization total="20">
            <FE name="Speaker"/>
            <pattern total="19">
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086375"/>
                <annoSet ID="2086377"/>
                <annoSet ID="2086381"/>
                <annoSet ID="2086393"/>
                <annoSet ID="2086399"/>
                <annoSet ID="2086403"/>
                <annoSet ID="2086407"/>
                <annoSet ID="2086413"/>
                <annoSet ID="2086675"/>
                <annoSet ID="2086677"/>
                <annoSet ID="2086681"/>
                <annoSet ID="2086685"/>
                <annoSet ID="2086691"/>
                <annoSet ID="2086695"/>
                <annoSet ID="2086705"/>
                <annoSet ID="2086713"/>
                <annoSet ID="2086743"/>
                <annoSet ID="2086787"/>
                <annoSet ID="2086801"/>
            </pattern>
            <pattern total="1">
                <valenceUnit GF="" PT="CNI" FE="Speaker"/>
                <annoSet ID="2086379"/>
            </pattern>
        </FERealization>
        <FERealization total="1">
            <FE name="Time"/>
            <pattern total="1">
                <valenceUnit GF="Dep" PT="AVP" FE="Time"/>
                <annoSet ID="2086713"/>
            </pattern>
        </FERealization>
        <FEGroupRealization total="3">
            <FE name="Experiencer"/>
            <FE name="Manner"/>
            <FE name="Message"/>
            <FE name="Speaker"/>
            <pattern total="1">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="AVP" FE="Manner"/>
                <valenceUnit GF="Dep" PT="QUO" FE="Message"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086801"/>
            </pattern>
            <pattern total="2">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="AVP" FE="Manner"/>
                <valenceUnit GF="Dep" PT="Sfin" FE="Message"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086381"/>
                <annoSet ID="2086407"/>
            </pattern>
        </FEGroupRealization>
        <FEGroupRealization total="2">
            <FE name="Experiencer"/>
            <FE name="Means"/>
            <FE name="Situation"/>
            <FE name="Speaker"/>
            <pattern total="1">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="PP[by]" FE="Means"/>
                <valenceUnit GF="Dep" PT="PP[about]" FE="Situation"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086681"/>
            </pattern>
            <pattern total="1">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="PP[with]" FE="Means"/>
                <valenceUnit GF="" PT="DNI" FE="Situation"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086705"/>
            </pattern>
        </FEGroupRealization>
        <FEGroupRealization total="1">
            <FE name="Experiencer"/>
            <FE name="Means"/>
            <FE name="Situation"/>
            <FE name="Speaker"/>
            <FE name="Speaker"/>
            <pattern total="1">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="PP[with]" FE="Means"/>
                <valenceUnit GF="" PT="DNI" FE="Situation"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086695"/>
            </pattern>
        </FEGroupRealization>
        <FEGroupRealization total="8">
            <FE name="Experiencer"/>
            <FE name="Message"/>
            <FE name="Speaker"/>
            <pattern total="2">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="QUO" FE="Message"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086743"/>
                <annoSet ID="2086787"/>
            </pattern>
            <pattern total="1">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="Sfin" FE="Message"/>
                <valenceUnit GF="" PT="CNI" FE="Speaker"/>
                <annoSet ID="2086379"/>
            </pattern>
            <pattern total="5">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="Sfin" FE="Message"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086375"/>
                <annoSet ID="2086377"/>
                <annoSet ID="2086393"/>
                <annoSet ID="2086399"/>
                <annoSet ID="2086413"/>
            </pattern>
        </FEGroupRealization>
        <FEGroupRealization total="1">
            <FE name="Experiencer"/>
            <FE name="Message"/>
            <FE name="Speaker"/>
            <FE name="Speaker"/>
            <pattern total="1">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="Sfin" FE="Message"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086403"/>
            </pattern>
        </FEGroupRealization>
        <FEGroupRealization total="1">
            <FE name="Experiencer"/>
            <FE name="Message"/>
            <FE name="Speaker"/>
            <FE name="Time"/>
            <pattern total="1">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="Sfin" FE="Message"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <valenceUnit GF="Dep" PT="AVP" FE="Time"/>
                <annoSet ID="2086713"/>
            </pattern>
        </FEGroupRealization>
        <FEGroupRealization total="4">
            <FE name="Experiencer"/>
            <FE name="Situation"/>
            <FE name="Speaker"/>
            <pattern total="4">
                <valenceUnit GF="Obj" PT="NP" FE="Experiencer"/>
                <valenceUnit GF="Dep" PT="PP[about]" FE="Situation"/>
                <valenceUnit GF="Ext" PT="NP" FE="Speaker"/>
                <annoSet ID="2086675"/>
                <annoSet ID="2086677"/>
                <annoSet ID="2086685"/>
                <annoSet ID="2086691"/>
            </pattern>
        </FEGroupRealization>
    </valences>
    <subCorpus name="01-T-NP-Wthat-NP-XP-VP-NP-XP-(1)">
        <sentence corpID="111" docID="421" sentNo="2" paragNo="147" aPos="61972207" ID="1319127">
            <text>Neither did the DFR reassure the bank that it would have an adequate security interest in the document representing the goods .</text>
            <annotationSet cDate="04/11/2005 03:25:51 PDT Mon" status="UNANN" ID="2086374">
                <layer rank="1" name="PENN">
                    <label end="6" start="0" name="dt"/>
                    <label end="10" start="8" name="VVD"/>
                    <label end="14" start="12" name="dt"/>
                    <label end="18" start="16" name="NP"/>
                    <label end="27" start="20" name="VV"/>
                    <label end="31" start="29" name="dt"/>
                    <label end="36" start="33" name="nn"/>
                    <label end="41" start="38" name="in"/>
                    <label end="44" start="43" name="PP"/>
                    <label end="50" start="46" name="md"/>
                    <label end="55" start="52" name="VH"/>
                    <label end="58" start="57" name="dt"/>
                    <label end="67" start="60" name="jj"/>
                    <label end="76" start="69" name="nn"/>
                    <label end="85" start="78" name="nn"/>
                    <label end="88" start="87" name="in"/>
                    <label end="92" start="90" name="dt"/>
                    <label end="101" start="94" name="nn"/>
                    <label end="114" start="103" name="VVG"/>
                    <label end="118" start="116" name="dt"/>
                    <label end="124" start="120" name="nns"/>
                    <label end="126" start="126" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:25:51 PDT Mon" status="AUTO_EDITED" ID="2086375">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="27" start="20" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="36" start="29" name="Experiencer"/>
                    <label cBy="Pam" feID="7717" end="18" start="12" name="Speaker"/>
                    <label cBy="Pam" feID="7719" end="124" start="38" name="Message"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="36" start="29" name="Obj"/>
                    <label end="18" start="12" name="Ext"/>
                    <label end="124" start="38" name="Dep"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="36" start="29" name="NP"/>
                    <label end="18" start="12" name="NP"/>
                    <label end="124" start="38" name="Sfin"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="6" paragNo="888" aPos="32294563" ID="1319128">
            <text>I always wrote the replies and told him the news and reassured him that Mum was watching his widow , which it gave her great pleasure to do .</text>
            <annotationSet cDate="04/11/2005 03:25:53 PDT Mon" status="UNANN" ID="2086376">
                <layer rank="1" name="PENN">
                    <label end="0" start="0" name="PP"/>
                    <label end="7" start="2" name="rb"/>
                    <label end="13" start="9" name="VVD"/>
                    <label end="17" start="15" name="dt"/>
                    <label end="25" start="19" name="nns"/>
                    <label end="29" start="27" name="cc"/>
                    <label end="34" start="31" name="VVD"/>
                    <label end="38" start="36" name="PP"/>
                    <label end="42" start="40" name="dt"/>
                    <label end="47" start="44" name="nn"/>
                    <label end="51" start="49" name="cc"/>
                    <label end="61" start="53" name="VVD"/>
                    <label end="65" start="63" name="PP"/>
                    <label end="70" start="67" name="in"/>
                    <label end="74" start="72" name="jj"/>
                    <label end="78" start="76" name="VBD"/>
                    <label end="87" start="80" name="VVG"/>
                    <label end="91" start="89" name="PP$"/>
                    <label end="97" start="93" name="nn"/>
                    <label end="99" start="99" name=","/>
                    <label end="105" start="101" name="wdt"/>
                    <label end="108" start="107" name="PP"/>
                    <label end="113" start="110" name="VVD"/>
                    <label end="117" start="115" name="PP$"/>
                    <label end="123" start="119" name="jj"/>
                    <label end="132" start="125" name="nn"/>
                    <label end="135" start="134" name="to"/>
                    <label end="138" start="137" name="VV"/>
                    <label end="140" start="140" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:25:54 PDT Mon" status="AUTO_EDITED" ID="2086377">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="61" start="53" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="65" start="63" name="Experiencer"/>
                    <label cBy="Pam" feID="7719" end="97" start="67" name="Message"/>
                    <label cBy="Pam" feID="7717" end="0" start="0" name="Speaker"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="65" start="63" name="Obj"/>
                    <label end="97" start="67" name="Dep"/>
                    <label end="0" start="0" name="Ext"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="65" start="63" name="NP"/>
                    <label end="97" start="67" name="Sfin"/>
                    <label end="0" start="0" name="NP"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="2" paragNo="117" aPos="4831162" ID="1319129">
            <text>The first reaction is to reassure Mr Gorbachev that there was no bold US ambition to take strategic advantage of the collapse of Moscow 's empire .</text>
            <annotationSet cDate="04/11/2005 03:25:54 PDT Mon" status="UNANN" ID="2086378">
                <layer rank="1" name="PENN">
                    <label end="2" start="0" name="dt"/>
                    <label end="8" start="4" name="jj"/>
                    <label end="17" start="10" name="nn"/>
                    <label end="20" start="19" name="VBZ"/>
                    <label end="23" start="22" name="to"/>
                    <label end="32" start="25" name="VV"/>
                    <label end="35" start="34" name="NP"/>
                    <label end="45" start="37" name="NP"/>
                    <label end="50" start="47" name="wdt"/>
                    <label end="56" start="52" name="ex"/>
                    <label end="60" start="58" name="VBD"/>
                    <label end="63" start="62" name="dt"/>
                    <label end="68" start="65" name="jj"/>
                    <label end="71" start="70" name="NP"/>
                    <label end="80" start="73" name="nn"/>
                    <label end="83" start="82" name="to"/>
                    <label end="88" start="85" name="VV"/>
                    <label end="98" start="90" name="jj"/>
                    <label end="108" start="100" name="nn"/>
                    <label end="111" start="110" name="in"/>
                    <label end="115" start="113" name="dt"/>
                    <label end="124" start="117" name="nn"/>
                    <label end="127" start="126" name="in"/>
                    <label end="134" start="129" name="NP"/>
                    <label end="137" start="136" name="POS"/>
                    <label end="144" start="139" name="nn"/>
                    <label end="146" start="146" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:25:54 PDT Mon" status="AUTO_EDITED" ID="2086379">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="32" start="25" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="45" start="34" name="Experiencer"/>
                    <label cBy="Pam" feID="7719" end="144" start="47" name="Message"/>
                    <label cBy="Pam" feID="7717" itype="CNI" name="Speaker"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="45" start="34" name="Obj"/>
                    <label end="144" start="47" name="Dep"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="45" start="34" name="NP"/>
                    <label end="144" start="47" name="Sfin"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="9" paragNo="463" aPos="19466762" ID="1319130">
            <text>Can I honestly reassure her that she will come to no harm in pursuing this phenomenon ?</text>
            <annotationSet cDate="04/11/2005 03:25:55 PDT Mon" status="UNANN" ID="2086380">
                <layer rank="1" name="PENN">
                    <label end="2" start="0" name="md"/>
                    <label end="4" start="4" name="PP"/>
                    <label end="13" start="6" name="rb"/>
                    <label end="22" start="15" name="VV"/>
                    <label end="26" start="24" name="PP"/>
                    <label end="31" start="28" name="in"/>
                    <label end="35" start="33" name="PP"/>
                    <label end="40" start="37" name="md"/>
                    <label end="45" start="42" name="VV"/>
                    <label end="48" start="47" name="to"/>
                    <label end="51" start="50" name="dt"/>
                    <label end="56" start="53" name="nn"/>
                    <label end="59" start="58" name="in"/>
                    <label end="68" start="61" name="VVG"/>
                    <label end="73" start="70" name="dt"/>
                    <label end="84" start="75" name="nn"/>
                    <label end="86" start="86" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:25:55 PDT Mon" status="AUTO_EDITED" ID="2086381">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="22" start="15" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="26" start="24" name="Experiencer"/>
                    <label cBy="Pam" feID="7717" end="4" start="4" name="Speaker"/>
                    <label cBy="Pam" feID="7724" end="13" start="6" name="Manner"/>
                    <label cBy="Pam" feID="7719" end="84" start="28" name="Message"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="26" start="24" name="Obj"/>
                    <label end="4" start="4" name="Ext"/>
                    <label end="13" start="6" name="Dep"/>
                    <label end="84" start="28" name="Dep"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="26" start="24" name="NP"/>
                    <label end="4" start="4" name="NP"/>
                    <label end="13" start="6" name="AVP"/>
                    <label end="84" start="28" name="Sfin"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="2" paragNo="364" aPos="6605702" ID="1319136">
            <text>Mr Talabani is said to have reassured his hosts that autonomy was the limit of his ambitions .</text>
            <annotationSet cDate="04/11/2005 03:25:58 PDT Mon" status="UNANN" ID="2086392">
                <layer rank="1" name="PENN">
                    <label end="1" start="0" name="NP"/>
                    <label end="10" start="3" name="NP"/>
                    <label end="13" start="12" name="VBZ"/>
                    <label end="18" start="15" name="VVN"/>
                    <label end="21" start="20" name="to"/>
                    <label end="26" start="23" name="VH"/>
                    <label end="36" start="28" name="VVN"/>
                    <label end="40" start="38" name="PP$"/>
                    <label end="46" start="42" name="nns"/>
                    <label end="51" start="48" name="in"/>
                    <label end="60" start="53" name="nn"/>
                    <label end="64" start="62" name="VBD"/>
                    <label end="68" start="66" name="dt"/>
                    <label end="74" start="70" name="nn"/>
                    <label end="77" start="76" name="in"/>
                    <label end="81" start="79" name="PP$"/>
                    <label end="91" start="83" name="nns"/>
                    <label end="93" start="93" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:25:58 PDT Mon" status="AUTO_EDITED" ID="2086393">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="36" start="28" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="46" start="38" name="Experiencer"/>
                    <label cBy="Pam" feID="7717" end="10" start="0" name="Speaker"/>
                    <label cBy="Pam" feID="7719" end="91" start="48" name="Message"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="46" start="38" name="Obj"/>
                    <label end="10" start="0" name="Ext"/>
                    <label end="91" start="48" name="Dep"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="46" start="38" name="NP"/>
                    <label end="10" start="0" name="NP"/>
                    <label end="91" start="48" name="Sfin"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="2" paragNo="5784" aPos="111243393" ID="1319139">
            <text>Councillor Joan Wade , of Stockton Borough Council , said she wanted to reassure senior citizens in the Stockton area that they can still use their passes to get to Langburgh .</text>
            <annotationSet cDate="04/11/2005 03:25:59 PDT Mon" status="UNANN" ID="2086398">
                <layer rank="1" name="PENN">
                    <label end="9" start="0" name="nn"/>
                    <label end="14" start="11" name="NP"/>
                    <label end="19" start="16" name="NP"/>
                    <label end="21" start="21" name=","/>
                    <label end="24" start="23" name="in"/>
                    <label end="33" start="26" name="NP"/>
                    <label end="41" start="35" name="NP"/>
                    <label end="49" start="43" name="NP"/>
                    <label end="51" start="51" name=","/>
                    <label end="56" start="53" name="VVD"/>
                    <label end="60" start="58" name="PP"/>
                    <label end="67" start="62" name="VVD"/>
                    <label end="70" start="69" name="to"/>
                    <label end="79" start="72" name="VV"/>
                    <label end="86" start="81" name="jj"/>
                    <label end="95" start="88" name="nns"/>
                    <label end="98" start="97" name="in"/>
                    <label end="102" start="100" name="dt"/>
                    <label end="111" start="104" name="NP"/>
                    <label end="116" start="113" name="nn"/>
                    <label end="121" start="118" name="in"/>
                    <label end="126" start="123" name="PP"/>
                    <label end="130" start="128" name="md"/>
                    <label end="136" start="132" name="rb"/>
                    <label end="140" start="138" name="VV"/>
                    <label end="146" start="142" name="PP$"/>
                    <label end="153" start="148" name="nns"/>
                    <label end="156" start="155" name="to"/>
                    <label end="160" start="158" name="VV"/>
                    <label end="163" start="162" name="to"/>
                    <label end="173" start="165" name="NP"/>
                    <label end="175" start="175" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:25:59 PDT Mon" status="AUTO_EDITED" ID="2086399">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="79" start="72" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="116" start="81" name="Experiencer"/>
                    <label cBy="Pam" feID="7717" end="60" start="58" name="Speaker"/>
                    <label cBy="Pam" feID="7719" end="173" start="118" name="Message"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="116" start="81" name="Obj"/>
                    <label end="60" start="58" name="Ext"/>
                    <label end="173" start="118" name="Dep"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="116" start="81" name="NP"/>
                    <label end="60" start="58" name="NP"/>
                    <label end="173" start="118" name="Sfin"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="1" paragNo="131" aPos="33034477" ID="1319141">
            <text>In the morning , Jack related his experience to his wife who listened sympathetically but reassured him that it must have been a nightmare .</text>
            <annotationSet cDate="04/11/2005 03:26:00 PDT Mon" status="UNANN" ID="2086402">
                <layer rank="1" name="PENN">
                    <label end="1" start="0" name="in"/>
                    <label end="5" start="3" name="dt"/>
                    <label end="13" start="7" name="nn"/>
                    <label end="15" start="15" name=","/>
                    <label end="20" start="17" name="NP"/>
                    <label end="28" start="22" name="VVD"/>
                    <label end="32" start="30" name="PP$"/>
                    <label end="43" start="34" name="nn"/>
                    <label end="46" start="45" name="to"/>
                    <label end="50" start="48" name="PP$"/>
                    <label end="55" start="52" name="nn"/>
                    <label end="59" start="57" name="wp"/>
                    <label end="68" start="61" name="VVD"/>
                    <label end="84" start="70" name="rb"/>
                    <label end="88" start="86" name="cc"/>
                    <label end="98" start="90" name="VVD"/>
                    <label end="102" start="100" name="PP"/>
                    <label end="107" start="104" name="in"/>
                    <label end="110" start="109" name="PP"/>
                    <label end="115" start="112" name="md"/>
                    <label end="120" start="117" name="VH"/>
                    <label end="125" start="122" name="VBN"/>
                    <label end="127" start="127" name="dt"/>
                    <label end="137" start="129" name="nn"/>
                    <label end="139" start="139" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:26:00 PDT Mon" status="AUTO_EDITED" ID="2086403">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="98" start="90" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="102" start="100" name="Experiencer"/>
                    <label cBy="Pam" feID="7717" end="55" start="48" name="Speaker"/>
                    <label cBy="Pam" feID="7719" end="137" start="104" name="Message"/>
                    <label cBy="Hay" feID="7717" end="59" start="57" name="Speaker"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="102" start="100" name="Obj"/>
                    <label end="55" start="48" name="Ext"/>
                    <label end="137" start="104" name="Dep"/>
                    <label end="59" start="57" name="Ext"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="102" start="100" name="NP"/>
                    <label end="55" start="48" name="NP"/>
                    <label end="137" start="104" name="Sfin"/>
                    <label end="59" start="57" name="NP"/>
                </layer>
                <layer rank="1" name="Other">
                    <label end="55" start="48" name="Ant"/>
                    <label end="59" start="57" name="Rel"/>
                </layer>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="8" paragNo="110" aPos="23499473" ID="1319143">
            <text>However , on his belated homecomings , he indirectly reassured her that the needed person did return m- the end .</text>
            <annotationSet cDate="04/11/2005 03:26:01 PDT Mon" status="UNANN" ID="2086406">
                <layer rank="1" name="PENN">
                    <label end="6" start="0" name="rb"/>
                    <label end="8" start="8" name=","/>
                    <label end="11" start="10" name="in"/>
                    <label end="15" start="13" name="PP$"/>
                    <label end="23" start="17" name="jj"/>
                    <label end="35" start="25" name="nns"/>
                    <label end="37" start="37" name=","/>
                    <label end="40" start="39" name="PP"/>
                    <label end="51" start="42" name="rb"/>
                    <label end="61" start="53" name="VVD"/>
                    <label end="65" start="63" name="PP"/>
                    <label end="70" start="67" name="in"/>
                    <label end="74" start="72" name="dt"/>
                    <label end="81" start="76" name="jj"/>
                    <label end="88" start="83" name="nn"/>
                    <label end="92" start="90" name="VVD"/>
                    <label end="99" start="94" name="nn"/>
                    <label end="102" start="101" name="nns"/>
                    <label end="106" start="104" name="dt"/>
                    <label end="110" start="108" name="nn"/>
                    <label end="112" start="112" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:26:01 PDT Mon" status="AUTO_EDITED" ID="2086407">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="61" start="53" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="65" start="63" name="Experiencer"/>
                    <label cBy="Pam" feID="7717" end="40" start="39" name="Speaker"/>
                    <label cBy="Pam" feID="7724" end="51" start="42" name="Manner"/>
                    <label cBy="Pam" feID="7719" end="110" start="67" name="Message"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="65" start="63" name="Obj"/>
                    <label end="40" start="39" name="Ext"/>
                    <label end="51" start="42" name="Dep"/>
                    <label end="110" start="67" name="Dep"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="65" start="63" name="NP"/>
                    <label end="40" start="39" name="NP"/>
                    <label end="51" start="42" name="AVP"/>
                    <label end="110" start="67" name="Sfin"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
        <sentence corpID="111" docID="421" sentNo="4" paragNo="434" aPos="46410646" ID="1319146">
            <text>I wish to reassure Andrew Allan and Andrew T Forsyth that our trial was indeed prospective .</text>
            <annotationSet cDate="04/11/2005 03:26:02 PDT Mon" status="UNANN" ID="2086412">
                <layer rank="1" name="PENN">
                    <label end="0" start="0" name="PP"/>
                    <label end="5" start="2" name="VVP"/>
                    <label end="8" start="7" name="to"/>
                    <label end="17" start="10" name="VV"/>
                    <label end="24" start="19" name="NP"/>
                    <label end="30" start="26" name="NP"/>
                    <label end="34" start="32" name="cc"/>
                    <label end="41" start="36" name="NP"/>
                    <label end="43" start="43" name="nn"/>
                    <label end="51" start="45" name="NP"/>
                    <label end="56" start="53" name="in"/>
                    <label end="60" start="58" name="PP$"/>
                    <label end="66" start="62" name="nn"/>
                    <label end="70" start="68" name="VBD"/>
                    <label end="77" start="72" name="rb"/>
                    <label end="89" start="79" name="jj"/>
                    <label end="91" start="91" name="sent"/>
                </layer>
                <layer rank="1" name="NER"/>
                <layer rank="1" name="WSL"/>
            </annotationSet>
            <annotationSet cDate="04/11/2005 03:26:02 PDT Mon" status="AUTO_EDITED" ID="2086413">
                <layer rank="1" name="Target">
                    <label cBy="Pam" end="17" start="10" name="Target"/>
                </layer>
                <layer rank="1" name="FE">
                    <label cBy="Pam" feID="7718" end="51" start="19" name="Experiencer"/>
                    <label cBy="Pam" feID="7717" end="0" start="0" name="Speaker"/>
                    <label cBy="Pam" feID="7719" end="89" start="53" name="Message"/>
                </layer>
                <layer rank="1" name="GF">
                    <label end="51" start="19" name="Obj"/>
                    <label end="0" start="0" name="Ext"/>
                    <label end="89" start="53" name="Dep"/>
                </layer>
                <layer rank="1" name="PT">
                    <label end="51" start="19" name="NP"/>
                    <label end="0" start="0" name="NP"/>
                    <label end="89" start="53" name="Sfin"/>
                </layer>
                <layer rank="1" name="Other"/>
                <layer rank="1" name="Sent"/>
                <layer rank="1" name="Verb"/>
            </annotationSet>
        </sentence>
    </subCorpus>
    <subCorpus name="02-T-PPby-(1)"/>
    <subCorpus name="02-T-PPabout-(1)"/>
    <subCorpus name="02-T-PPwith-(1)"/>
    <subCorpus name="03-NP-T-(1)"/>
    <subCorpus name="other-matched-(1)"/>
    <subCorpus name="other-unmatched-(1)"/>
    <subCorpus name="01-T-NP-PPby-(2)"/>
    <subCorpus name="01-T-NP-PPabout-(2)">
        <sentence corpID="111" docID="421" sentNo="1" paragNo="181" aPos="98459084" ID="1319277">
            <text>He reassured Reed about local assistance .</text>
            <